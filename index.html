<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SpellMoji ‚Äî Spelling Game</title>
<style>
:root{
  --bg:#f6fbff; --card:#fff; --panel:#eef6ff; --accent:#2b7cff; --accent-2:#49e3b6;
  --text:#062033; --muted:#6b7280; --ok:#0db57d; --err:#e03e3e;
}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#eaf6ff 0%,#f6fbff 100%);margin:0;color:var(--text);padding:20px;display:flex;justify-content:center}
.app{max-width:980px;width:100%}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
h1{margin:0;font-size:1.4rem}
.badge{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:6px 10px;border-radius:999px;font-weight:700}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(11,18,32,.06);margin-bottom:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
label{font-weight:600;font-size:.95rem}
textarea,input,select,button{font-size:1rem;padding:8px;border-radius:8px;border:1px solid #e6eefc}
textarea{min-height:90px;width:100%}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.emoji-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
.emoji-btn{background:#fff;border-radius:10px;border:1px solid #e6eefc;padding:8px;font-size:26px;cursor:pointer}
.emoji-btn.selected{outline:3px solid rgba(43,124,255,.12);transform:translateY(-2px)}
.emoji-btn.disabled{opacity:.5;pointer-events:none}
.center{text-align:center}
.muted{color:var(--muted)}
.small{font-size:.9rem}
.status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chip{background:#f1f8ff;padding:6px 10px;border-radius:999px;border:1px solid #dceeff}
.letters{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.letter{min-width:26px;padding:6px 8px;border-radius:8px;border:1px solid #eef6ff;background:#fbfdff;text-align:center}
.letter.correct{background:#e6ffef;border-color:#8be59f}
.letter.wrong{background:#ffecec;border-color:#ff9b9b;color:#9a1a1a}
.feedback{font-weight:700;margin-top:8px}
.hidden{display:none}
.controls-right{margin-left:auto}
.footer{font-size:.85rem;color:var(--muted);text-align:center;margin-top:6px}
@media(max-width:700px){ .emoji-grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
<div class="app" role="application" aria-label="SpellMoji spelling game">
  <div class="header">
    <h1>SpellMoji <span class="badge">v1</span></h1>
    <div class="small muted">Pedagogy: emoji understanding ‚Üí produce spelling ‚Üí review ‚Üí reward</div>
  </div>

  <!-- Setup -->
  <section class="card" aria-labelledby="setupTitle">
    <h2 id="setupTitle">1) Build your list</h2>
    <div class="small muted">Enter one word per line. Optional: use " | emoji" after the word to set the correct emoji (e.g. "apple | üçé"). Choose language for speech.</div>
    <label for="wordList">Spellings (one per line)</label>
    <textarea id="wordList" placeholder="Example:
apple | üçé
m√∫inteoir | üë©‚Äçüè´
family"></textarea>

    <div class="row" style="margin-top:8px">
      <label class="small">Language
        <select id="voiceLang">
          <option value="en-IE">English (Irish accent)</option>
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="ga-IE">Gaeilge (Irish)</option>
        </select>
      </label>

      <label class="small">Reward per mastered (seconds)
        <select id="rewardPer">
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="90">90s</option>
        </select>
      </label>

      <div class="controls controls-right">
        <button id="loadBtn" class="primary">Load words</button>
        <button id="startBtn">Start practice</button>
        <button id="resetBtn">Reset</button>
      </div>
    </div>
    <p class="small muted" style="margin-top:8px">Tip: If you include an emoji after a pipe it will be used as the correct answer in the matching step.</p>
  </section>

  <!-- Session -->
  <section id="session" class="card hidden" aria-live="polite">
    <div class="row" style="align-items:center">
      <div>
        <div class="muted small">Progress</div>
        <div id="progressText"><span id="curIndex">0</span> / <span id="totalCount">0</span></div>
      </div>

      <div class="controls">
        <button id="sayBtn">üîä Say again</button>
        <button id="replayAudio" class="hidden">Replay</button>
      </div>

      <div class="controls controls-right">
        <div class="chip">Mastered: <span id="masteredCount">0</span></div>
        <div class="chip">Missed: <span id="missedCount">0</span></div>
      </div>
    </div>

    <hr style="margin:10px 0">

    <div id="stepEmoji">
      <div class="muted small">2) Emoji match ‚Äî show understanding: pick the correct emoji</div>
      <div id="emojiPrompt" class="center" style="margin-top:8px"></div>
      <div id="emojiGrid" class="emoji-grid" role="list"></div>
      <div id="emojiFeedback" class="small muted" style="margin-top:6px"></div>
    </div>

    <div id="stepSpell" class="hidden" style="margin-top:12px">
      <div class="muted small">3) Spell the word you hear (type only letters)</div>
      <div style="margin-top:8px">
        <input id="spellingInput" type="text" inputmode="text" placeholder="Type the spelling..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefc" />
        <div id="letterFeedback" class="letters" aria-live="polite"></div>
        <div id="phoneticHint" class="small muted" style="margin-top:6px"></div>
        <div class="row" style="margin-top:8px">
          <button id="submitBtn" class="primary">Submit</button>
          <button id="hintBtn">Phonetic hint</button>
          <button id="skipBtn">Skip</button>
        </div>
      </div>
    </div>

    <div id="endSession" class="hidden" style="margin-top:12px">
      <h3 class="center">Session summary</h3>
      <p class="center small muted">Mastered: <span id="sumMastered">0</span> | Need practice: <span id="sumMissed">0</span></p>

      <div class="row" style="justify-content:center;margin-top:8px">
        <label class="small">Bonus per retry:
          <select id="bonusPer">
            <option value="0">No bonus</option>
            <option value="30">+30s</option>
            <option value="60" selected>+60s</option>
          </select>
        </label>
        <button id="claimReward">Claim reward</button>
      </div>

      <div class="center" style="margin-top:10px">
        <button id="retryMissed">Practice missed words again</button>
        <button id="finishBtn">Finish</button>
      </div>

      <div id="rewardArea" class="hidden" style="margin-top:12px">
        <div class="small muted center">Reward time available: <span id="rewardSeconds">0</span>s</div>
        <div class="center" style="margin-top:6px">
          <button id="startTimer">Start timer</button>
        </div>
        <div id="timerDisplay" class="center small muted" style="margin-top:6px"></div>
      </div>
    </div>

  </section>

  <p class="footer">Uses your browser's speech synthesis. Works locally; the timer is a helper for device time management.</p>
</div>

<script>
// --- Utilities & state ---
const $ = id => document.getElementById(id);
let state = {
  entries: [], // {word, emoji, chosenEmoji, status:'new'|'mastered'|'missed', attempts:0}
  index: 0,
  rewardSeconds: 0,
  retryMode: false
};
const STORAGE_KEY = 'spellmoji_state_v2';

// --- DOM refs
const loadBtn = $('loadBtn'), startBtn = $('startBtn'), resetBtn = $('resetBtn');
const session = $('session'), emojiGrid = $('emojiGrid'), emojiFeedback = $('emojiFeedback');
const stepEmoji = $('stepEmoji'), stepSpell = $('stepSpell'), spellingInput = $('spellingInput');
const submitBtn = $('submitBtn'), hintBtn = $('hintBtn'), skipBtn = $('skipBtn'), sayBtn = $('sayBtn');
const letterFeedback = $('letterFeedback'), phoneticHint = $('phoneticHint');
const curIndex = $('curIndex'), totalCount = $('totalCount'), masteredCount = $('masteredCount'), missedCount = $('missedCount');
const endSession = $('endSession'), sumMastered = $('sumMastered'), sumMissed = $('sumMissed');
const retryMissed = $('retryMissed'), finishBtn = $('finishBtn'), claimReward = $('claimReward'), rewardSecondsEl = $('rewardSeconds');
const startTimer = $('startTimer'), timerDisplay = $('timerDisplay'), bonusPer = $('bonusPer');
const loadLang = $('voiceLang'), rewardPer = $('rewardPer');
const wordListTA = $('wordList');

// --- Persistence
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) state = JSON.parse(raw);
  } catch(e){}
}
load();

// --- Parsing input
function parseList(text) {
  return text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(l => {
    const parts = l.split('|').map(p=>p.trim());
    return { word: parts[0], emoji: parts[1]||'', chosenEmoji:'', status:'new', attempts:0 };
  });
}

// --- Build 4-choice emoji set for one correct emoji
const DEFAULT_POOL = ['üçé','üçå','üçì','üçï','üç™','üë©‚Äçüè´','üè´','üè†','üöó','üê∂','üê±','ü¶ã','üå≥','‚òïÔ∏è','üéÅ','‚öΩ','üé∏','üìö','‚úèÔ∏è','üéÇ','üçü'];
function makeChoices(correct) {
  const pool = Array.from(new Set([correct, ...DEFAULT_POOL])).filter(Boolean);
  // pick 3 random distractors not equal to correct
  const distractors = pool.filter(p=>p!==correct);
  shuffle(distractors);
  const choices = [correct, ...distractors.slice(0,3)];
  shuffle(choices);
  return choices;
}

// --- Helpers
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function speak(text) {
  if(!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = loadLang.value || 'en-IE';
  const voices = speechSynthesis.getVoices();
  // pick voice best match
  const pref = voices.find(v=>v.lang && v.lang.startsWith(u.lang.split('-')[0]));
  if(pref) u.voice = pref;
  u.rate = 0.95;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// --- UI: Load & start ---
loadBtn.addEventListener('click', ()=>{
  const raw = wordListTA.value.trim();
  if(!raw){ alert('Please enter at least one word.'); return; }
  state.entries = parseList(raw);
  // if entries had emoji in source, keep as correct; otherwise choose later
  state.index = 0; state.rewardSeconds = state.rewardSeconds || 0; state.retryMode = false;
  state.entries.forEach(e=>{ if(!e.emoji) e.emoji = ''; e.status='new'; e.attempts=0; });
  save();
  totalCount.textContent = state.entries.length;
  curIndex.textContent = 0;
  masteredCount.textContent = 0;
  missedCount.textContent = 0;
  alert(`Loaded ${state.entries.length} words. Proceed to Emoji match step.`);
  switchToSession();
  renderCurrentEmojiChoices();
});

startBtn.addEventListener('click', ()=> {
  if(!state.entries || !state.entries.length) {
    // try to build from textarea automatically
    state.entries = parseList(wordListTA.value || '');
    if(!state.entries.length){ alert('Add words first'); return; }
  }
  state.index = 0;
  state.entries.forEach(e=>{ e.status='new'; e.attempts=0; e.chosenEmoji=''; });
  state.rewardSeconds = 0;
  state.retryMode = false;
  save();
  totalCount.textContent = state.entries.length;
  switchToSession();
  renderCurrentEmojiChoices();
});

// Reset
resetBtn.addEventListener('click', ()=>{
  if(confirm('Reset everything (clears saved progress)?')) {
    state = {entries:[],index:0,rewardSeconds:0,retryMode:false};
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
});

// --- Session flow & rendering ---
function switchToSession(){
  session.classList.remove('hidden');
  $('stepSpell').classList.add('hidden'); // ensure emoji first
  stepEmoji.classList.remove('hidden');
  stepSpell.classList.add('hidden');
  endSession.classList.add('hidden');
  updateCounts();
}

function updateCounts(){
  const total = state.entries.length || 0;
  const mastered = state.entries.filter(e=>e.status==='mastered').length;
  const missed = state.entries.filter(e=>e.status==='missed').length;
  totalCount.textContent = total;
  masteredCount.textContent = mastered;
  missedCount.textContent = missed;
  curIndex.textContent = Math.min(state.index+1, total);
}

// Render emoji choices for current entry
function renderCurrentEmojiChoices(){
  emojiGrid.innerHTML = '';
  emojiFeedback.textContent = '';
  const e = state.entries[state.index];
  if(!e) { endRun(); return; }
  // determine correct emoji:
  const correct = e.emoji || pickEmojiForWord(e.word) || '‚≠ê';
  const choices = makeChoices(correct);
  choices.forEach(ch => {
    const btn = document.createElement('button');
    btn.className='emoji-btn';
    btn.setAttribute('aria-label','emoji choice');
    btn.innerText = ch;
    btn.addEventListener('click', ()=> onEmojiSelected(ch));
    emojiGrid.appendChild(btn);
  });
  // prompt speak-only
  speak(e.word);
}

// Auto pick a sensible emoji for a word (very lightweight heuristics)
function pickEmojiForWord(word){
  const w = word.toLowerCase();
  if(/\\b(cat|dog|fish|horse|cow|sheep|pig)\\b/.test(w)) return 'üê∂';
  if(/\\b(apple|banana|cake|cookie|pizza|burger|chips|chips|chocolate)\\b/.test(w)) return 'üç™';
  if(/\\b(school|teacher|class|teach|m√∫inteoir)\\b/.test(w)) return 'üë©‚Äçüè´';
  if(/\\b(home|house|apartment|√°ras√°n)\\b/.test(w)) return 'üè†';
  if(/\\b(car|bus|train|bike|plane|rocket)\\b/.test(w)) return 'üöó';
  if(/\\b(book|read|library)\\b/.test(w)) return 'üìö';
  if(/\\b(music|song|sing|guitar)\\b/.test(w)) return 'üé∏';
  return '' ;
}

// When child picks an emoji
function onEmojiSelected(chosen){
  const e = state.entries[state.index];
  // determine correct emoji
  const correct = e.emoji || pickEmojiForWord(e.word) || '‚≠ê';
  if(chosen === correct){
    // good ‚Äî allow move to spelling step
    e.chosenEmoji = chosen;
    emojiFeedback.textContent = 'Great choice! Now spell the word.';
    // disable emoji area and show spelling step
    Array.from(emojiGrid.children).forEach(b=>b.classList.add('disabled'));
    setTimeout(()=> {
      stepEmoji.classList.add('hidden');
      stepSpell.classList.remove('hidden');
      spellingInput.focus();
    }, 600);
  } else {
    // wrong pick ‚Äî gentle feedback, allow retry (max 2 wrong emoji attempts)
    e.attempts = (e.attempts || 0) + 1;
    emojiFeedback.textContent = e.attempts < 2 ? 'Not quite ‚Äî try another emoji. Think about the meaning.' : 'Still not correct ‚Äî we will mark this for review and continue.';
    if(e.attempts >= 2){
      e.status = 'missed';
      state.rewardSeconds = state.rewardSeconds; // no reward
      // move on to spelling step still but note incorrect
      e.chosenEmoji = chosen;
      Array.from(emojiGrid.children).forEach(b=>b.classList.add('disabled'));
      setTimeout(()=> {
        stepEmoji.classList.add('hidden');
        stepSpell.classList.remove('hidden');
        spellingInput.focus();
      }, 700);
    }
  }
  save();
  updateCounts();
}

// Spell step: submit handler
submitBtn.addEventListener('click', checkSpelling);
spellingInput.addEventListener('keydown', e => { if(e.key==='Enter') checkSpelling(); });

function normalize(s){ return s.normalize('NFKC').replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø']/g,'').toLowerCase(); }

function checkSpelling(){
  const e = state.entries[state.index];
  if(!e) return;
  const guess = (spellingInput.value||'').trim();
  if(!guess){ alert('Type the spelling before submitting.'); return; }
  const correct = normalize(e.word);
  const attempt = normalize(guess);
  renderLetterFeedback(e.word, guess);
  if(attempt === correct){
    // correct
    e.status = 'mastered';
    state.rewardSeconds += parseInt(rewardPer.value || '60',10);
    $('phoneticHint').textContent = '';
    // immediate positive feedback
    showFeedback('Correct! +'+(rewardPer.value||'60')+'s', true);
    // advance after a short pause
    setTimeout(()=> { state.index++; proceedOrEnd(); }, 700);
  } else {
    // wrong spelling
    e.status = 'missed';
    e.attempts = (e.attempts||0)+1;
    showFeedback('Not quite ‚Äî try again. Use hint if needed.', false);
    phoneticHint.textContent = buildPhoneticHint(e.word, guess);
    save();
  }
  save(); updateCounts();
}

function renderLetterFeedback(target, guess){
  letterFeedback.innerHTML = '';
  const maxL = Math.max(target.length, guess.length);
  for(let i=0;i<maxL;i++){
    const t = target[i]||'';
    const g = guess[i]||'';
    const span = document.createElement('div');
    span.className = 'letter';
    if(!g) span.textContent = '_';
    else if(g.toLowerCase() === (t||'').toLowerCase()){
      span.textContent = g;
      span.classList.add('correct');
    } else {
      span.textContent = g;
      span.classList.add('wrong');
    }
    letterFeedback.appendChild(span);
  }
}

// Phonetic hint builder (simple, scaffold)
function buildPhoneticHint(word, guess){
  const vowels = /[aeiou√°√©√≠√≥√∫]/i;
  const lower = word.toLowerCase();
  const firstV = lower.match(vowels);
  const pos = firstWrongPos(guess, word);
  let hint = '';
  if(pos>=0){
    const seg = word.slice(0,pos+1);
    hint = `Build the word: \\n`;  

    return hint;
  }
  return hint;
}
// Add more functions as needed...
</script>
</body>
</html>
